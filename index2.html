<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>אפליקציית רובוטים ומיקרוביט</title>
    <!-- ייבוא ספריות Blockly מה-CDN -->
    <script src="https://unpkg.com/blockly/blockly_compressed.js"></script>
    <script src="https://unpkg.com/blockly/blocks_compressed.js"></script>
    <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
    <script src="https://unpkg.com/blockly/python_compressed.js"></script>
    <script src="https://unpkg.com/blockly/msg/he.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            height: 100vh;
            text-align: right;
            direction: rtl;
        }

        h1 {
            color: #4A4A4A;
            text-align: center;
            padding: 20px;
            margin: 0;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #blockly-container {
            display: flex;
            flex-grow: 1;
            padding: 20px;
            gap: 20px;
        }

        #blocklyDiv {
            flex: 2;
            min-height: 500px;
            border-radius: 15px;
            border: 2px solid #ddd;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        #code-panel {
            flex: 1;
            min-height: 500px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #code-output {
            flex-grow: 1;
            background-color: #333;
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Consolas', 'Courier New', monospace;
            white-space: pre;
            overflow: auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .action-button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.2s;
        }

        .action-button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        /* הגדלת גודל הבלוקים ב-20% */
        .blocklySvg > g > .blocklyDraggable {
            transform: scale(1.2);
            transform-origin: top right; /* כיוון הגידול */
        }
        
        .blocklyTreeRow {
            font-size: 18px !important;
        }
        .blocklyTreeRow.blocklyTreeSelected {
            border-radius: 5px;
        }

        #message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            text-align: center;
        }

        #message-box.show {
            display: block;
        }

        #message-box p {
            font-size: 18px;
            color: #333;
        }
    </style>
</head>
<body>

    <h1>בקר רובוטים עם בלוקים!</h1>

    <div id="blockly-container">
        <!-- סביבת העבודה של Blockly -->
        <div id="blocklyDiv"></div>
        
        <!-- פאנל הצגת קוד -->
        <div id="code-panel">
            <h2>קוד שנוצר (Python)</h2>
            <pre id="code-output"></pre>
            <div class="action-buttons">
                <button class="action-button" onclick="runCode()">הפעל קוד</button>
            </div>
        </div>
    </div>

    <!-- הגדרת ה-Toolbox ב-XML -->
    <xml id="toolbox" style="display: none">
        <!-- קטגוריות בסיסיות של Blockly -->
        <category name="לולאות" colour="#3E8F4A">
            <block type="controls_repeat_ext">
                <value name="TIMES">
                    <block type="math_number">
                        <field name="NUM">10</field>
                    </block>
                </value>
            </block>
            <block type="controls_whileUntil"></block>
        </category>
        <category name="לוגיקה" colour="#5C81A6">
            <block type="controls_if"></block>
            <block type="logic_compare"></block>
            <block type="logic_operation"></block>
        </category>
        <category name="מספרים" colour="#5CA55C">
            <block type="math_number"></block>
            <block type="math_arithmetic"></block>
        </category>

        <!-- קטגוריות מותאמות אישית -->
        <category name="רובוט" colour="#E28943">
            <block type="robot_move"></block>
            <block type="robot_turn"></block>
            <block type="robot_stop"></block>
            <block type="robot_set_speed"></block>
        </category>

        <category name="מיקרוביט" colour="#B64A7E">
            <block type="microbit_display_icon"></block>
            <block type="microbit_on_button_pressed"></block>
            <block type="microbit_show_text"></block>
            <block type="microbit_set_pin"></block>
        </category>
    </xml>

    <!-- תיבת הודעה מותאמת אישית -->
    <div id="message-box">
        <p id="message-text"></p>
    </div>

    <script type="text/javascript">
        // הגדרת בלוקים מותאמים אישית
        Blockly.Blocks['robot_move'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("הרץ רובוט")
                    .appendField(new Blockly.FieldDropdown([["קדימה","FORWARD"], ["אחורה","BACKWARD"]]), "DIRECTION")
                    .appendField("במשך")
                    .appendField(new Blockly.FieldNumber(1, 0), "DURATION")
                    .appendField("שניות");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(20);
                this.setTooltip("מזיז את הרובוט בכיוון מסוים למשך זמן נתון.");
            }
        };

        // מחולל קוד Python לבלוק 'robot_move'
        Blockly.Python['robot_move'] = function(block) {
            const direction = block.getFieldValue('DIRECTION');
            const duration = block.getFieldValue('DURATION');
            return `robot.move(direction='${direction}', duration=${duration})\n`;
        };

        Blockly.Blocks['robot_turn'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("סובב רובוט")
                    .appendField(new Blockly.FieldDropdown([["שמאלה","LEFT"], ["ימינה","RIGHT"]]), "DIRECTION")
                    .appendField("במשך")
                    .appendField(new Blockly.FieldNumber(1, 0), "DURATION")
                    .appendField("שניות");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(20);
                this.setTooltip("מסובב את הרובוט בכיוון מסוים.");
            }
        };

        // מחולל קוד Python לבלוק 'robot_turn'
        Blockly.Python['robot_turn'] = function(block) {
            const direction = block.getFieldValue('DIRECTION');
            const duration = block.getFieldValue('DURATION');
            return `robot.turn(direction='${direction}', duration=${duration})\n`;
        };

        Blockly.Blocks['robot_stop'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("עצור רובוט");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(20);
                this.setTooltip("עוצר את הרובוט.");
            }
        };

        // מחולל קוד Python לבלוק 'robot_stop'
        Blockly.Python['robot_stop'] = function(block) {
            return `robot.stop()\n`;
        };
        
        Blockly.Blocks['robot_set_speed'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("קבע מהירות")
                    .appendField(new Blockly.FieldNumber(50, 0, 100), "SPEED")
                    .appendField("%");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(20);
                this.setTooltip("מגדיר את מהירות הרובוט באחוזים.");
            }
        };

        // מחולל קוד Python לבלוק 'robot_set_speed'
        Blockly.Python['robot_set_speed'] = function(block) {
            const speed = block.getFieldValue('SPEED');
            return `robot.set_speed(${speed})\n`;
        };
        
        // בלוקים של מיקרוביט
        Blockly.Blocks['microbit_display_icon'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("הצג אייקון")
                    .appendField(new Blockly.FieldDropdown([["לב","HEART"], ["שמחה","HAPPY"], ["עצב","SAD"]]), "ICON");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(300);
                this.setTooltip("מציג אייקון על מסך ה-LED של המיקרוביט.");
            }
        };

        // מחולל קוד Python לבלוק 'microbit_display_icon'
        Blockly.Python['microbit_display_icon'] = function(block) {
            const icon = block.getFieldValue('ICON');
            return `microbit.display_icon('${icon}')\n`;
        };

        Blockly.Blocks['microbit_on_button_pressed'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("כאשר כפתור")
                    .appendField(new Blockly.FieldDropdown([["A","A"], ["B","B"]]), "BUTTON")
                    .appendField("נלחץ");
                this.appendStatementInput("DO")
                    .setCheck(null);
                this.setColour(300);
                this.setTooltip("מפעיל קוד כאשר כפתור נלחץ.");
            }
        };
        
        // מחולל קוד Python לבלוק 'microbit_on_button_pressed'
        Blockly.Python['microbit_on_button_pressed'] = function(block) {
            const button = block.getFieldValue('BUTTON');
            const statements = Blockly.Python.statementToCode(block, 'DO');
            return `microbit.on_button_pressed('${button}', function():\n${Blockly.Python.INDENT}${statements})\n`;
        };

        Blockly.Blocks['microbit_show_text'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("הצג טקסט")
                    .appendField(new Blockly.FieldTextInput("שלום"), "TEXT");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(300);
                this.setTooltip("מציג טקסט נתון על מסך ה-LED.");
            }
        };

        // מחולל קוד Python לבלוק 'microbit_show_text'
        Blockly.Python['microbit_show_text'] = function(block) {
            const text = block.getFieldValue('TEXT');
            return `microbit.show_text("${text}")\n`;
        };

        Blockly.Blocks['microbit_set_pin'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("קבע פין")
                    .appendField(new Blockly.FieldNumber(0, 0, 16), "PIN")
                    .appendField("לערך")
                    .appendField(new Blockly.FieldNumber(0, 0, 1), "VALUE");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(300);
                this.setTooltip("קובע את הערך של פין דיגיטלי.");
            }
        };

        // מחולל קוד Python לבלוק 'microbit_set_pin'
        Blockly.Python['microbit_set_pin'] = function(block) {
            const pin = block.getFieldValue('PIN');
            const value = block.getFieldValue('VALUE');
            return `microbit.set_pin(${pin}, ${value})\n`;
        };

        // פונקציה להתאמת גודל סביבת העבודה
        function adjustBlocklySize() {
            const blocklyDiv = document.getElementById('blocklyDiv');
            const container = document.getElementById('blockly-container');
            if (blocklyDiv && container) {
                const containerRect = container.getBoundingClientRect();
                blocklyDiv.style.width = containerRect.width + 'px';
                blocklyDiv.style.height = containerRect.height + 'px';
                Blockly.svgResize(workspace);
            }
        }

        // יצירת סביבת העבודה של Blockly
        const workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'),
            media: 'https://unpkg.com/blockly/media/',
            zoom: {
                controls: true,
                wheel: true,
                startScale: 1.0,
                maxScale: 3,
                minScale: 0.3,
                scaleSpeed: 1.2
            },
            rtl: true,
        });

        // פונקציה שמייצרת קוד כשסביבת העבודה משתנה
        function generateCode(event) {
            const code = Blockly.Python.workspaceToCode(workspace);
            document.getElementById('code-output').textContent = code;
        }

        workspace.addChangeListener(generateCode);

        // פונקציה שמציגה הודעה מותאמת אישית
        function showMessage(message) {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            messageText.textContent = message;
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        }

        // פונקציה לדוגמה שמדמה הפעלת קוד
        function runCode() {
            showMessage('הקוד נשלח לרובוט! (זוהי הדמיה בלבד)');
        }

        // התאמת גודל התצוגה בעת טעינת הדף ושינוי גודל החלון
        window.addEventListener('load', adjustBlocklySize);
        window.addEventListener('resize', adjustBlocklySize);

    </script>
</body>
</html>
