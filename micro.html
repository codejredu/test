<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>צורב micro:bitSIM (WebUSB)</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for right-to-left layout and aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            color: #1f2937;
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-2xl bg-white p-6 md:p-10 rounded-xl shadow-2xl border border-gray-100">
        <h1 class="text-3xl font-bold mb-6 text-center text-indigo-700">כלי צריבה ל-micro:bit</h1>
        
        <!-- Status Area -->
        <div id="status-container" class="mb-6 p-4 rounded-lg bg-gray-100 text-center font-medium transition-all duration-300">
            <p id="connection-status" class="text-gray-600">סטטוס חיבור: <span class="font-bold text-red-500">מנותק</span></p>
        </div>

        <!-- Code Input Area -->
        <label for="micropython-code" class="block text-lg font-semibold mb-2 text-gray-700">1. הדבק קוד MicroPython:</label>
        <textarea id="micropython-code" rows="10" 
                  class="w-full p-4 border-2 border-indigo-200 rounded-lg focus:border-indigo-500 focus:ring-indigo-500 transition duration-150 ease-in-out text-left font-mono text-sm resize-y" 
                  placeholder="הזן את קוד MicroPython שלך כאן... לדוגמה:&#10;from microbit import *&#10;display.scroll('Hello')">
from microbit import *
while True:
    display.show(Image.HEART)
    sleep(500)
    display.show(Image.HEART_SMALL)
    sleep(500)
        </textarea>

        <div class="mt-8 space-y-4 md:space-y-0 md:space-x-4 flex flex-col md:flex-row-reverse">
            <!-- Flash Button -->
            <button id="flash-button" disabled 
                    class="flex-1 w-full md:w-auto px-6 py-3 text-white font-bold rounded-xl shadow-lg 
                           bg-green-600 hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed 
                           transition duration-200 transform hover:scale-[1.02] active:scale-100 focus:outline-none focus:ring-4 focus:ring-green-300">
                3. צרוב קוד לכרטיס
            </button>
            
            <!-- Connect Button -->
            <button id="connect-button" 
                    class="flex-1 w-full md:w-auto px-6 py-3 text-white font-bold rounded-xl shadow-lg 
                           bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed 
                           transition duration-200 transform hover:scale-[1.02] active:scale-100 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                2. התחבר ל-micro:bit (WebUSB)
            </button>
        </div>

        <p class="text-xs text-gray-500 mt-6 text-center">היישום משתמש בספריית @microbit/microbit-connection (דרך WebUSB). ודא שה-micro:bit שלך מחובר בכבל USB.</p>
    </div>

    <!-- JavaScript Module for WebUSB connection -->
    <script type="module">
        // Import the required functions from the microbit-connection library via unpkg CDN
        // Note: The import happens here, but the event listeners are attached only after 'load'
        import { createWebUSBConnection, ConnectionStatus } from "https://unpkg.com/@microbit/microbit-connection@0.1.0-alpha.5/dist/microbit-connection.mjs";

        // --- Global Variables ---
        let usbConnection = null;
        let connectButton, flashButton, statusElement, codeArea;

        /**
         * @param {string} message 
         * @param {string} colorClass 
         * @param {boolean} isConnected 
         */
        function updateStatus(message, colorClass, isConnected = false) {
            if (statusElement && connectButton && flashButton) {
                statusElement.innerHTML = `סטטוס חיבור: <span class="${colorClass} font-bold">${message}</span>`;
                connectButton.disabled = isConnected;
                flashButton.disabled = !isConnected;
            }
        }

        // --- Main Initialization and Event Listener Setup ---
        window.addEventListener('load', () => {
            // Get DOM elements after the page is fully loaded
            connectButton = document.getElementById('connect-button');
            flashButton = document.getElementById('flash-button');
            statusElement = document.getElementById('connection-status');
            codeArea = document.getElementById('micropython-code');
            
            updateStatus('מנותק', 'text-red-500', false);
            console.log("micro:bit Flasher Initialized and ready.");

            // --- Connection Logic (Step 2) ---
            connectButton.addEventListener('click', async () => {
                // Check for WebUSB support first
                if (!navigator.usb) {
                    updateStatus('שגיאה: WebUSB אינו נתמך בדפדפן זה.', 'text-red-600', false);
                    console.error("WebUSB API not available in this browser.");
                    return;
                }

                updateStatus('מתחבר...', 'text-yellow-600', false);
                
                // Re-initialize connection object if null or disconnected
                if (usbConnection === null || usbConnection.status === ConnectionStatus.DISCONNECTED) {
                    try {
                        usbConnection = createWebUSBConnection();
                    } catch (error) {
                        console.error("Failed to create WebUSB connection object:", error);
                        updateStatus('שגיאת אתחול WebUSB', 'text-red-600', false);
                        return;
                    }
                }

                // 2. Attempt to connect (This is the call that triggers the browser's device selection dialog)
                try {
                    const connectionStatus = await usbConnection.connect();
                    console.log("Connection Status:", connectionStatus);

                    if (connectionStatus === ConnectionStatus.CONNECTED) {
                        updateStatus('מחובר (CONNECTED)', 'text-green-600', true);
                    } else if (connectionStatus === ConnectionStatus.NOT_FOUND) {
                         updateStatus('לא נמצא (NOT_FOUND)', 'text-red-600', false);
                         usbConnection = null; // Reset
                    } else if (connectionStatus === ConnectionStatus.DISCONNECTED) {
                         updateStatus('החיבור בוטל/נותק.', 'text-red-600', false);
                         usbConnection = null; // Reset
                    } else {
                        updateStatus('חיבור נכשל', 'text-red-600', false);
                        usbConnection = null; // Reset
                    }
                } catch (error) {
                    // Catch user cancellation (e.g., closing the dialog) or security errors
                    console.error("Connection error:", error);
                    
                    const isUserCancelled = error.message.includes('No device selected') || error.name === 'NotFoundError';

                    const errorMessage = isUserCancelled ? 'המשתמש ביטל את הבחירה.' : 'שגיאת חיבור (בדוק קונסול)';
                    updateStatus(errorMessage, 'text-red-600', false);

                    // Crucial: Reset connection object to allow the button to try again fresh
                    usbConnection = null; 
                }
            });

            // --- Flashing Logic (Step 3) ---
            flashButton.addEventListener('click', async () => {
                if (!usbConnection || usbConnection.status !== ConnectionStatus.CONNECTED) {
                    updateStatus('אנא התחבר קודם!', 'text-red-600', false);
                    return;
                }

                // IMPORTANT: The HexPlaceholder MUST be replaced with a real hex file string 
                // containing the MicroPython runtime and the user's code for actual functionality.
                const HexPlaceholder = "In a real app, this would be a large, valid micro:bit hex string containing the MicroPython runtime and your code.";

                updateStatus('צורב... (0%)', 'text-yellow-600', true);

                try {
                    // Import the necessary function
                    const module = await import("https://unpkg.com/@microbit/microbit-connection@0.1.0-alpha.5/dist/microbit-connection.mjs");
                    const { createUniversalHexFlashDataSource } = module;
                    
                    // Start the flash process
                    await usbConnection.flash(createUniversalHexFlashDataSource(HexPlaceholder), {
                        partial: true,
                        progress: (percentage) => {
                            const percent = percentage !== undefined ? Math.round(percentage * 100) : '...';
                            updateStatus(`צורב... (${percent}%)`, 'text-yellow-600', true);
                            console.log(`Flash progress: ${percent}%`);
                        },
                    });

                    // If successful
                    updateStatus('הצריבה הסתיימה בהצלחה!', 'text-green-600', true);
                    console.log("Flash successful.");
                    
                } catch (error) {
                    console.error("Flashing or import error:", error);
                    updateStatus(`שגיאת צריבה: ${error.message || 'כללית'}`, 'text-red-600', true);
                }
            });
            
            // Log for Firestore debugging (best practice, though not used here)
            if (typeof setLogLevel === 'function') { setLogLevel('Debug'); }
        });
    </script>
</body>
</html>
