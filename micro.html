<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>עורך MicroPython ל-Micro:bit</title>
    <!-- טעינת Tailwind CSS להתאמה ועיצוב מהיר -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* הגדרת גופן אינטר (Inter) ותצוגה כללית */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* התאמת גודל תיבת הטקסט לכל הגובה הזמין במסך קטן */
        #code-editor {
            resize: none;
            min-height: 400px; /* גובה מינימלי למחשב שולחני */
        }
        @media (max-width: 768px) {
            #code-editor {
                min-height: 300px; /* גובה מתאים יותר למובייל */
            }
        }
        /* סגנון לקונסולה הווירטואלית */
        #console-output {
            max-height: 200px;
            overflow-y: auto;
            background-color: #1f2937; /* אפור כהה */
            color: #d1d5db; /* טקסט בהיר */
            direction: ltr; /* קונסולה תמיד משמאל לימין */
            text-align: left;
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            line-height: 1rem;
        }
    </style>
    
    <!-- ייבוא ספריית הצריבה DAPjs - חיוני לשימוש ב-WebUSB -->
    <script src="https://cdn.jsdelivr.net/npm/dapjs@latest/dist/dap.min.js"></script>
    
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl p-6 md:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">עורך MicroPython ל-Micro:bit: צריבה ישירה (WebUSB)</h1>
        <p id="user-id-display" class="text-xs text-gray-400 mb-4">מזהה משתמש: טוען...</p>
        
        <!-- עורך הקוד -->
        <textarea id="code-editor" 
                  class="w-full p-4 border-4 border-indigo-200 rounded-lg font-mono text-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200/50 transition duration-150 shadow-inner"
                  placeholder="כתוב את קוד ה-MicroPython שלך כאן...">
# MicroPython Code for micro:bit - קוד דוגמה

from microbit import *

display.show("GO")

while True:
    if button_a.is_pressed():
        display.show(Image.YES)
    else:
        display.show(Image.NO)
    sleep(100)
        </textarea>
        
        <div class="mt-6 flex flex-col sm:flex-row gap-4 justify-center">
            
            <!-- לחצן הצריבה הישירה (WebUSB) -->
            <button id="flash-button" 
                    onclick="connectAndFlash()"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition duration-150 ease-in-out hover:scale-105 active:scale-95 flex items-center justify-center">
                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                התחבר וצרוב ישירות ל-Micro:bit
            </button>

            <!-- לחצן שמירת קובץ PY (אפשרות גיבוי) -->
            <button id="download-button" 
                    onclick="downloadCode()"
                    class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition duration-150 ease-in-out hover:scale-105 active:scale-95 flex items-center justify-center">
                הורד קובץ קוד (.py)
            </button>
        </div>

        <!-- אזור הודעות וסטטוס (סטטוס אחרון מודגש) -->
        <div id="status-box" class="mt-6 p-4 bg-blue-100 border-l-4 border-blue-500 text-blue-800 rounded-lg" role="status">
            <p class="font-bold">סטטוס אחרון:</p>
            <p id="status-text">טוען נתונים מהענן...</p>
        </div>
        
        <!-- קונסולת פלט לרישום אירועים בזמן אמת -->
        <div class="mt-4">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">פלט קונסולה:</h2>
            <div id="console-output" class="rounded-lg border border-gray-300">
                <!-- הודעות קונסולה יוזרמו לכאן -->
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // setLogLevel('Debug'); // פתח הערה זו לצורך ניפוי באגים של Firebase

        const editor = document.getElementById('code-editor');
        const statusBox = document.getElementById('status-box');
        const statusText = document.getElementById('status-text');
        const consoleOutput = document.getElementById('console-output');

        // --- משתני FIREBASE ו-UX ---
        let db;
        let auth;
        let userId = 'loading';
        let isAuthReady = false;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let saveTimeout = null;
        const SAVE_DELAY = 1000; // Debounce של שנייה אחת לשמירה אוטומטית

        // --- משתני WEBUSB ---
        const microbitVendorId = 0x0D28;
        const microbitProductId = 0x0204;
        const BASE_HEX_URL = 'https://microbit.org/static/microbit-micropython-v2-universal.hex';
        let baseHexContent = null;
        let daplinkInstance = null;
        
        /**
         * פונקציה לרישום הודעות לקונסולה הווירטואלית.
         */
        function logToConsole(message, type = 'info') {
            const time = new Date().toLocaleTimeString('he-IL', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            const entry = document.createElement('div');
            
            let color = 'text-gray-400';
            if (type === 'success') {
                color = 'text-green-400 font-medium';
            } else if (type === 'error') {
                color = 'text-red-400 font-bold';
            } else if (type === 'warn') {
                color = 'text-yellow-400';
            }

            entry.className = `font-mono text-xs p-1 border-b border-gray-700 ${color}`;
            entry.textContent = `[${time}] ${message}`;
            consoleOutput.appendChild(entry);
            // גלילה אוטומטית לתחתית
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        /**
         * פונקציה לעדכון תיבת הסטטוס בצבעים שונים, ורישום לקונסולה.
         */
        function updateStatus(message, colorClass = 'bg-blue-100 border-blue-500 text-blue-800') {
            statusBox.className = `mt-6 p-4 border-l-4 rounded-lg ${colorClass}`;
            statusText.textContent = message;
            statusBox.classList.remove('hidden');
            
            // רישום לקונסולה
            let type = 'info';
            if (colorClass.includes('red')) type = 'error';
            if (colorClass.includes('green')) type = 'success';
            if (colorClass.includes('yellow')) type = 'warn';
            logToConsole(`סטטוס UI: ${message}`, type);
        }
        
        /**
         * מפעיל את Firebase ומטפל באימות.
         */
        async function initFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase configuration not found. Code persistence disabled.");
                // **תיקון הבאג: הגדרת isAuthReady ל-true כאשר Firebase מושבת, כדי לאפשר WebUSB**
                updateStatus("אזהרה: אחסון קוד אוטומטי בענן מושבת. צריבה ישירה עדיין פועלת.", 'bg-yellow-100 border-yellow-500 text-yellow-800');
                isAuthReady = true; // מאפשר הרצת WebUSB מיד
                userId = crypto.randomUUID(); // שימוש ב-ID רנדומלי במקום ID של Firebase
                return;
            }

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        logToConsole(`מחובר כמשתמש: ${userId}.`);
                        loadCodeFromFirestore();
                    } else {
                        userId = crypto.randomUUID();
                        isAuthReady = true;
                        logToConsole("התחברות אנונימית בוצעה בהצלחה.");
                    }
                    document.getElementById('user-id-display').textContent = `מזהה משתמש: ${userId.substring(0, 8)}...`;
                    updateStatus(`מערכת מוכנה. קוד נטען אוטומטית מהענן.`, 'bg-indigo-100 border-indigo-500 text-indigo-800');
                });

            } catch (error) {
                console.error("Firebase Auth Error:", error);
                updateStatus(`שגיאת אימות: ${error.message}. אחסון קוד מושבת.`, 'bg-red-100 border-red-500 text-red-800');
            }
        }

        /**
         * טוען את קוד הפייתון מה-Firestore ומתחיל האזנה לשינויים.
         */
        function loadCodeFromFirestore() {
            if (!isAuthReady || !db) return;

            // נתיב נתונים פרטי: /artifacts/{appId}/users/{userId}/user_code/main
            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'user_code', 'main');

            onSnapshot(docRef, (doc) => {
                if (doc.exists() && doc.data().code) {
                    const savedCode = doc.data().code;
                    // רק מעדכן אם הקוד שונה (כדי למנוע לולאות אינסופיות של שמירה/טעינה)
                    if (editor.value !== savedCode) {
                        editor.value = savedCode;
                        logToConsole("הקוד נטען אוטומטית מהענן.", 'success');
                    }
                } else {
                    logToConsole("לא נמצא קוד שמור קודם, השתמש בקוד הדוגמה.");
                }
            }, (error) => {
                console.error("Error listening to code changes:", error);
                logToConsole("שגיאה בטעינת הקוד השמור: " + error.message, 'error');
            });
        }

        /**
         * שומר את קוד הפייתון הנוכחי ל-Firestore עם Debounce.
         */
        function saveCodeToFirestore() {
            if (!isAuthReady || !db) return;

            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'user_code', 'main');
                try {
                    await setDoc(docRef, { 
                        code: editor.value,
                        timestamp: new Date().toISOString()
                    }, { merge: true });
                    logToConsole("שמירה אוטומטית הושלמה.", 'success');
                } catch (e) {
                    console.error("Error saving document: ", e);
                    logToConsole("שגיאה בשמירה אוטומטית: " + e.message, 'error');
                }
            }, SAVE_DELAY);
        }

        /**
         * טוען את קובץ ה-HEX הבסיסי מהרשת בפעם הראשונה.
         */
        async function loadBaseHex() {
            if (baseHexContent) {
                return baseHexContent;
            }

            updateStatus("טוען קושחת MicroPython בסיסית (כ-2MB)...", 'bg-yellow-100 border-yellow-500 text-yellow-800');
            
            try {
                const response = await fetch(BASE_HEX_URL);
                if (!response.ok) {
                    throw new Error(`שגיאת טעינה: ${response.status} ${response.statusText}`);
                }
                baseHexContent = await response.text();
                updateStatus("קושחת הבסיס נטענה בהצלחה.", 'bg-blue-100 border-blue-500 text-blue-800');
                return baseHexContent;
            } catch (error) {
                console.error("Failed to load base HEX:", error);
                updateStatus(`שגיאה בטעינת קושחת הבסיס מהרשת: ${error.message}. נסה שוב.`, 'bg-red-100 border-red-500 text-red-800');
                throw error;
            }
        }

        /**
         * פונקציה שמזריקה את קוד הפייתון של המשתמש לקובץ ה-HEX הבסיסי.
         * הפונקציה משתמשת בשיטת הזרקת ה-Intel HEX (הוספת רשומות חדשות).
         */
        function injectScript(baseHex, scriptContent) {
            const SCRIPT_ADDRESS = '0003E000';
            
            // 1. קבלת קוד הפייתון בפורמט HEX/ASCII.
            const scriptBytes = new TextEncoder().encode(scriptContent);
            const scriptLength = scriptBytes.length;

            // 2. יצירת ה-Header: 2 בתים 'MP' + 2 בתים אורך (Little Endian).
            const header = [
                0x4D, 0x50, // 'MP'
                (scriptLength & 0xFF), 
                ((scriptLength >> 8) & 0xFF) 
            ];
            
            let combinedHex = baseHex.trim();
            const newline = '\r\n';

            // פונקציית עזר לחישוב Checksum
            const checksum = (data) => {
                let sum = data.reduce((a, b) => a + b, 0);
                return (0x100 - (sum & 0xFF)) & 0xFF;
            };
            
            combinedHex += newline;

            // 3. הוספת רשומות הקוד
            let currentAddress = parseInt(SCRIPT_ADDRESS, 16) + 4; // מתחיל אחרי ה-Header (4 בתים)
            const bytesPerRecord = 32;

            // הוספת ה-Header כרשומת קוד רגילה (Type 00)
            const headerChunk = new Uint8Array(header);
            const headerRecord = createHexRecord(headerChunk, parseInt(SCRIPT_ADDRESS, 16), checksum);
            combinedHex += headerRecord + newline;
            
            // הוספת רשומות הקוד בפועל
            for (let i = 0; i < scriptBytes.length; i += bytesPerRecord) {
                const chunk = scriptBytes.slice(i, i + bytesPerRecord);
                const address = currentAddress;
                currentAddress += chunk.length;
                
                const record = createHexRecord(chunk, address, checksum);
                combinedHex += record + newline;
            }
            
            // הוספת סוף הקובץ (EOF) - חשוב שיהיה הרשומה האחרונה
            combinedHex += ':00000001FF'; 

            return combinedHex;
        }

        function createHexRecord(chunk, address, checksumFunc) {
            let record = ':';
            // Byte Count (1 byte)
            record += chunk.length.toString(16).padStart(2, '0').toUpperCase();
            // Address (2 bytes)
            record += (address & 0xFFFF).toString(16).padStart(4, '0').toUpperCase();
            // Record Type (00)
            record += '00';

            // Data (N bytes)
            let dataSum = chunk.length + (address & 0xFF) + ((address >> 8) & 0xFF);
            let dataString = '';
            chunk.forEach(byte => {
                dataString += byte.toString(16).padStart(2, '0').toUpperCase();
                dataSum += byte;
            });
            record += dataString;

            // Checksum (1 byte)
            const recordChecksum = checksumFunc(dataSum);
            record += recordChecksum.toString(16).padStart(2, '0').toUpperCase();
            
            return record;
        }


        /**
         * פונקציה לטיפול בתהליך החיבור והצריבה הישירה באמצעות WebUSB.
         */
        async function connectAndFlash() {
            // ה-check הזה עדיין חשוב כאשר Firebase פעיל, כדי לוודא שה-onAuthStateChanged הסתיים
            if (!isAuthReady) {
                updateStatus("המערכת עדיין מתחברת לאימות (Firebase). אנא המתן מספר שניות.", 'bg-yellow-100 border-yellow-500 text-yellow-800');
                return;
            }

            if (!navigator.usb || typeof DAPjs === 'undefined') {
                updateStatus("דפדפן זה אינו תומך ב-WebUSB או ספריית DAPjs חסרה.", 
                              'bg-red-100 border-red-500 text-red-800');
                return;
            }

            if (window.location.protocol !== 'https:') {
                updateStatus("דרוש חיבור מאובטח (HTTPS) כדי להשתמש ב-WebUSB. אנא העלה את האפליקציה לשרת מאובטח.", 
                              'bg-red-100 border-red-500 text-red-800');
                return;
            }

            try {
                // 1. טעינת קושחת הבסיס (במידת הצורך)
                const baseHex = await loadBaseHex();

                updateStatus("2. מבקש חיבור ל-Micro:bit (תופיע חלונית בחירת מכשיר)...", 'bg-yellow-100 border-yellow-500 text-yellow-800');

                // 3. בקשה לבחירת מכשיר Micro:bit
                const device = await navigator.usb.requestDevice({
                    filters: [{ vendorId: microbitVendorId, productId: microbitProductId }]
                });

                if (!device) {
                    updateStatus("החיבור בוטל או לא נמצא מכשיר Micro:bit.", 'bg-red-100 border-red-500 text-red-800');
                    return;
                }
                
                updateStatus(`3. התחברות ל-${device.productName}...`, 'bg-indigo-100 border-indigo-500 text-indigo-800');
                
                // 4. יצירת מופע DAPLink וחיבור
                daplinkInstance = new DAPjs.DAPLink(device);
                await daplinkInstance.connect();

                updateStatus("4. הזרקת קוד פייתון לקושחה...", 'bg-purple-100 border-purple-500 text-purple-800');
                
                // 5. הזרקת קוד המשתמש לקובץ ה-HEX
                const userCode = editor.value;
                const combinedHex = injectScript(baseHex, userCode);
                
                updateStatus("5. מתחיל צריבה... (פעולה זו עשויה לקחת כדקה)", 'bg-green-100 border-green-500 text-green-800');

                // פונקציית קריאה חוזרת (Callback) לעדכון סטטוס הצריבה
                const progressCallback = (progress) => {
                    updateStatus(`6. צריבה מתקדמת: ${Math.round(progress * 100)}%`, 'bg-green-100 border-green-500 text-green-800');
                };
                
                // 7. הצריבה בפועל
                await daplinkInstance.flash(combinedHex, progressCallback);
                
                updateStatus("✅ הצריבה הושלמה בהצלחה! ה-Micro:bit יאתחל מחדש ויריץ את הקוד.", 'bg-green-600 border-green-700 text-white');


            } catch (error) {
                console.error("WebUSB/Flash Error:", error);
                
                if (error.message.includes('No device selected')) {
                     updateStatus("החיבור בוטל על ידי המשתמש.", 'bg-red-100 border-red-500 text-red-800');
                } else {
                    updateStatus(`שגיאה קריטית: ${error.message}. ודא שה-Micro:bit מחובר ושדפדפן Chrome/Edge פועל ב-HTTPS.`, 'bg-red-600 border-red-700 text-white');
                }
            } finally {
                // ניתוק DAPLink בסיום
                if (daplinkInstance) {
                    // מנותק אוטומטית ע"י DAPjs לאחר הצריבה
                    daplinkInstance = null;
                }
            }
        }


        /**
         * פונקציית הורדת קובץ .py לגיבוי.
         */
        function downloadCode() {
            const codeContent = editor.value;
            const filename = 'microbit_program.py';
            
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(codeContent));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);

            updateStatus("קובץ ה-.py הורד. זהו קובץ קוד גולמי.", 'bg-yellow-100 border-yellow-500 text-yellow-800');
        }

        // --- LISTENERS והתחלת פעולה ---
        editor.addEventListener('input', saveCodeToFirestore);
        window.onload = initFirebase;
    </script>

</body>
</html>
